---
timestamp: 'Thu Nov 06 2025 23:43:48 GMT-0500 (Eastern Standard Time)'
content_id: 0df90d7b895c4a80b79f96281566bbc1961dd42d483f91b140697294dfd3a1dc
---

# file: src/syncs/api.sync.ts

```typescript
/**
 * This file contains synchronizations for handling authenticated routes
 * that have been excluded from automatic passthrough in `passthrough.ts`.
 * It follows a standard request/response pattern for each excluded endpoint.
 */

import {
  Comment,
  FileUrl,
  MusicTagging,
  Requesting,
  Sessioning,
  UserAuthentication,
} from "@concepts";
import { actions, Sync } from "@engine";

// -- UserAuthentication -- //

// Delete User
export const DeleteUserRequest: Sync = ({ request, username, password }) => ({
  when: actions([
    Requesting.request,
    { path: "/UserAuthentication/deleteUser", username, password },
    { request },
  ]),
  then: actions([UserAuthentication.deleteUser, { username, password }]),
});

export const DeleteUserResponseSuccess: Sync = ({ request }) => ({
  when: actions(
    [Requesting.request, { path: "/UserAuthentication/deleteUser" }, {
      request,
    }],
    [UserAuthentication.deleteUser, {}, {}],
  ),
  then: actions([Requesting.respond, { request, status: "deleted" }]),
});

export const DeleteUserResponseError: Sync = ({ request, error }) => ({
  when: actions(
    [Requesting.request, { path: "/UserAuthentication/deleteUser" }, {
      request,
    }],
    [UserAuthentication.deleteUser, {}, { error }],
  ),
  then: actions([Requesting.respond, { request, error }]),
});

// Change Password
export const ChangePasswordRequest: Sync = (
  { request, username, oldPassword, newPassword },
) => ({
  when: actions([
    Requesting.request,
    {
      path: "/UserAuthentication/changePassword",
      username,
      oldPassword,
      newPassword,
    },
    { request },
  ]),
  then: actions(
    [UserAuthentication.changePassword, { username, oldPassword, newPassword }],
  ),
});

export const ChangePasswordResponseSuccess: Sync = ({ request }) => ({
  when: actions(
    [Requesting.request, { path: "/UserAuthentication/changePassword" }, {
      request,
    }],
    [UserAuthentication.changePassword, {}, {}],
  ),
  then: actions([Requesting.respond, { request, status: "changed" }]),
});

export const ChangePasswordResponseError: Sync = ({ request, error }) => ({
  when: actions(
    [Requesting.request, { path: "/UserAuthentication/changePassword" }, {
      request,
    }],
    [UserAuthentication.changePassword, {}, { error }],
  ),
  then: actions([Requesting.respond, { request, error }]),
});

// -- Comment -- //

// Register Resource for Commenting
export const RegisterCommentResourceRequest: Sync = (
  { request, session, resource },
) => ({
  when: actions([
    Requesting.request,
    { path: "/Comment/register", session, resource },
    { request },
  ]),
  // Requires a valid session, but any logged-in user can register a resource.
  where: (frames) => frames.query(Sessioning._getUser, { session }, {}),
  then: actions([Comment.register, { resource }]),
});

export const RegisterCommentResourceResponse: Sync = ({ request }) => ({
  when: actions(
    [Requesting.request, { path: "/Comment/register" }, { request }],
    [Comment.register, {}, {}],
  ),
  then: actions([Requesting.respond, { request, status: "registered" }]),
});

export const RegisterCommentResourceError: Sync = ({ request, error }) => ({
  when: actions(
    [Requesting.request, { path: "/Comment/register" }, { request }],
    [Comment.register, {}, { error }],
  ),
  then: actions([Requesting.respond, { request, error }]),
});

// Add Comment
export const AddCommentRequest: Sync = (
  { request, session, user, resource, text, date },
) => ({
  when: actions([
    Requesting.request,
    { path: "/Comment/addComment", session, resource, text, date },
    { request },
  ]),
  where: (frames) => frames.query(Sessioning._getUser, { session }, { user }),
  then: actions(
    [Comment.addComment, { resource, commenter: user, text, date }],
  ),
});

export const AddCommentResponseSuccess: Sync = ({ request, comment }) => ({
  when: actions(
    [Requesting.request, { path: "/Comment/addComment" }, { request }],
    [Comment.addComment, {}, { comment }],
  ),
  then: actions([Requesting.respond, { request, comment }]),
});

export const AddCommentResponseError: Sync = ({ request, error }) => ({
  when: actions(
    [Requesting.request, { path: "/Comment/addComment" }, { request }],
    [Comment.addComment, {}, { error }],
  ),
  then: actions([Requesting.respond, { request, error }]),
});

// Remove Comment
export const RemoveCommentRequest: Sync = (
  { request, session, user, comment },
) => ({
  when: actions([
    Requesting.request,
    { path: "/Comment/removeComment", session, comment },
    { request },
  ]),
  where: (frames) => frames.query(Sessioning._getUser, { session }, { user }),
  then: actions([Comment.removeComment, { comment, user }]),
});

export const RemoveCommentResponseSuccess: Sync = ({ request }) => ({
  when: actions(
    [Requesting.request, { path: "/Comment/removeComment" }, { request }],
    [Comment.removeComment, {}, {}],
  ),
  then: actions([Requesting.respond, { request, status: "removed" }]),
});

export const RemoveCommentResponseError: Sync = ({ request, error }) => ({
  when: actions(
    [Requesting.request, { path: "/Comment/removeComment" }, { request }],
    [Comment.removeComment, {}, { error }],
  ),
  then: actions([Requesting.respond, { request, error }]),
});

// -- FileUrl -- //

// Request Upload URL
export const RequestUploadRequest: Sync = (
  { request, session, user, fileName },
) => ({
  when: actions([
    Requesting.request,
    { path: "/FileUrl/requestUpload", session, fileName },
    { request },
  ]),
  where: (frames) => frames.query(Sessioning._getUser, { session }, { user }),
  then: actions([FileUrl.requestUpload, { fileName, owner: user }]),
});

export const RequestUploadResponseSuccess: Sync = (
  { request, uploadUrl, gcsObjectName },
) => ({
  when: actions(
    [Requesting.request, { path: "/FileUrl/requestUpload" }, { request }],
    [FileUrl.requestUpload, {}, { uploadUrl, gcsObjectName }],
  ),
  then: actions(
    [Requesting.respond, { request, uploadUrl, gcsObjectName }],
  ),
});

export const RequestUploadResponseError: Sync = ({ request, error }) => ({
  when: actions(
    [Requesting.request, { path: "/FileUrl/requestUpload" }, { request }],
    [FileUrl.requestUpload, {}, { error }],
  ),
  then: actions([Requesting.respond, { request, error }]),
});

// Confirm Upload
export const ConfirmUploadRequest: Sync = (
  { request, session, user, fileName, title, gcsObjectName },
) => ({
  when: actions([
    Requesting.request,
    { path: "/FileUrl/confirmUpload", session, fileName, title, gcsObjectName },
    { request },
  ]),
  where: (frames) => frames.query(Sessioning._getUser, { session }, { user }),
  then: actions(
    [FileUrl.confirmUpload, { fileName, title, gcsObjectName, owner: user }],
  ),
});

export const ConfirmUploadResponseSuccess: Sync = ({ request, file }) => ({
  when: actions(
    [Requesting.request, { path: "/FileUrl/confirmUpload" }, { request }],
    [FileUrl.confirmUpload, {}, { file }],
  ),
  then: actions([Requesting.respond, { request, file }]),
});

export const ConfirmUploadResponseError: Sync = ({ request, error }) => ({
  when: actions(
    [Requesting.request, { path: "/FileUrl/confirmUpload" }, { request }],
    [FileUrl.confirmUpload, {}, { error }],
  ),
  then: actions([Requesting.respond, { request, error }]),
});

// Delete File
export const DeleteFileRequest: Sync = ({ request, session, user, file }) => ({
  when: actions([
    Requesting.request,
    { path: "/FileUrl/deleteFile", session, file },
    { request },
  ]),
  where: (frames) => frames.query(Sessioning._getUser, { session }, { user }),
  then: actions([FileUrl.deleteFile, { file, user }]),
});

export const DeleteFileResponseSuccess: Sync = ({ request }) => ({
  when: actions(
    [Requesting.request, { path: "/FileUrl/deleteFile" }, { request }],
    [FileUrl.deleteFile, {}, {}],
  ),
  then: actions([Requesting.respond, { request, status: "deleted" }]),
});

export const DeleteFileResponseError: Sync = ({ request, error }) => ({
  when: actions(
    [Requesting.request, { path: "/FileUrl/deleteFile" }, { request }],
    [FileUrl.deleteFile, {}, { error }],
  ),
  then: actions([Requesting.respond, { request, error }]),
});

// Get View URL
export const GetViewUrlRequest: Sync = (
  { request, session, gcsObjectName },
) => ({
  when: actions([
    Requesting.request,
    { path: "/FileUrl/getViewUrl", session, gcsObjectName },
    { request },
  ]),
  // Requires a valid session to get a temporary view URL.
  where: (frames) => frames.query(Sessioning._getUser, { session }, {}),
  then: actions([FileUrl.getViewUrl, { gcsObjectName }]),
});

export const GetViewUrlResponseSuccess: Sync = ({ request, viewUrl }) => ({
  when: actions(
    [Requesting.request, { path: "/FileUrl/getViewUrl" }, { request }],
    [FileUrl.getViewUrl, {}, { viewUrl }],
  ),
  then: actions([Requesting.respond, { request, viewUrl }]),
});

export const GetViewUrlResponseError: Sync = ({ request, error }) => ({
  when: actions(
    [Requesting.request, { path: "/FileUrl/getViewUrl" }, { request }],
    [FileUrl.getViewUrl, {}, { error }],
  ),
  then: actions([Requesting.respond, { request, error }]),
});

// -- MusicTagging -- //

// Register Resource
export const MusicRegisterResourceRequest: Sync = (
  { request, session, resource, description },
) => ({
  when: actions([
    Requesting.request,
    { path: "/MusicTagging/registerResource", session, resource, description },
    { request },
  ]),
  // Requires valid session to register a new music resource
  where: (frames) => frames.query(Sessioning._getUser, { session }, {}),
  then: actions([MusicTagging.registerResource, { resource, description }]),
});

export const MusicRegisterResourceResponseSuccess: Sync = (
  { request, registry },
) => ({
  when: actions(
    [Requesting.request, { path: "/MusicTagging/registerResource" }, {
      request,
    }],
    [MusicTagging.registerResource, {}, { registry }],
  ),
  then: actions([Requesting.respond, { request, registry }]),
});

export const MusicRegisterResourceResponseError: Sync = (
  { request, error },
) => ({
  when: actions(
    [Requesting.request, { path: "/MusicTagging/registerResource" }, {
      request,
    }],
    [MusicTagging.registerResource, {}, { error }],
  ),
  then: actions([Requesting.respond, { request, error }]),
});

// Add Tag
export const MusicAddTagRequest: Sync = (
  { request, session, registry, tag },
) => ({
  when: actions([
    Requesting.request,
    { path: "/MusicTagging/addTag", session, registry, tag },
    { request },
  ]),
  where: (frames) => frames.query(Sessioning._getUser, { session }, {}),
  then: actions([MusicTagging.addTag, { registry, tag }]),
});

export const AddTagResponseSuccess: Sync = ({ request }) => ({
  when: actions(
    [Requesting.request, { path: "/MusicTagging/addTag" }, { request }],
    [MusicTagging.addTag, {}, {}],
  ),
  then: actions([Requesting.respond, { request, status: "tag_added" }]),
});

export const AddTagResponseError: Sync = ({ request, error }) => ({
  when: actions(
    [Requesting.request, { path: "/MusicTagging/addTag" }, { request }],
    [MusicTagging.addTag, {}, { error }],
  ),
  then: actions([Requesting.respond, { request, error }]),
});

// Remove Tag
export const MusicRemoveTagRequest: Sync = (
  { request, session, registry, tag },
) => ({
  when: actions([
    Requesting.request,
    { path: "/MusicTagging/removeTag", session, registry, tag },
    { request },
  ]),
  where: (frames) => frames.query(Sessioning._getUser, { session }, {}),
  then: actions([MusicTagging.removeTag, { registry, tag }]),
});

export const RemoveTagResponseSuccess: Sync = ({ request }) => ({
  when: actions(
    [Requesting.request, { path: "/MusicTagging/removeTag" }, { request }],
    [MusicTagging.removeTag, {}, {}],
  ),
  then: actions([Requesting.respond, { request, status: "tag_removed" }]),
});

export const RemoveTagResponseError: Sync = ({ request, error }) => ({
  when: actions(
    [Requesting.request, { path: "/MusicTagging/removeTag" }, { request }],
    [MusicTagging.removeTag, {}, { error }],
  ),
  then: actions([Requesting.respond, { request, error }]),
});

// Delete Registry
export const MusicDeleteRegistryRequest: Sync = (
  { request, session, registry },
) => ({
  when: actions([
    Requesting.request,
    { path: "/MusicTagging/deleteRegistry", session, registry },
    { request },
  ]),
  where: (frames) => frames.query(Sessioning._getUser, { session }, {}),
  then: actions([MusicTagging.deleteRegistry, { registry }]),
});

export const DeleteRegistryResponseSuccess: Sync = ({ request }) => ({
  when: actions(
    [Requesting.request, { path: "/MusicTagging/deleteRegistry" }, {
      request,
    }],
    [MusicTagging.deleteRegistry, {}, {}],
  ),
  then: actions([Requesting.respond, { request, status: "registry_deleted" }]),
});

export const DeleteRegistryResponseError: Sync = ({ request, error }) => ({
  when: actions(
    [Requesting.request, { path: "/MusicTagging/deleteRegistry" }, {
      request,
    }],
    [MusicTagging.deleteRegistry, {}, { error }],
  ),
  then: actions([Requesting.respond, { request, error }]),
});

export const SuggestTagsRequest: Sync = (
  { request, session, description, currentTags },
) => ({
  when: actions([
    Requesting.request,
    { path: "/MusicTagging/suggestTags", session, description, currentTags },
    { request },
  ]),
  where: (frames) => frames.query(Sessioning._getUser, { session }, {}),
  then: actions([MusicTagging.suggestTags, {
    description,
    existingTags: currentTags,
  }]),
});

export const SuggestTagsResponseSuccess: Sync = (
  { request, tags },
) => ({
  when: actions(
    [Requesting.request, { path: "/MusicTagging/suggestTags" }, { request }],
    [MusicTagging.suggestTags, {}, { tags }],
  ),
  then: actions([Requesting.respond, { request, suggestedTags: tags }]),
});

export const SuggestTagsResponseError: Sync = ({ request, error }) => ({
  when: actions(
    [Requesting.request, { path: "/MusicTagging/suggestTags" }, { request }],
    [MusicTagging.suggestTags, {}, { error }],
  ),
  then: actions([Requesting.respond, { request, error }]),
});

//-- User Registration --//
export const RegisterRequest: Sync = ({ request, username, password }) => ({
  when: actions([Requesting.request, {
    path: "/UserAuthentication/register",
    username,
    password,
  }, { request }]),
  then: actions([UserAuthentication.register, { username, password }]),
});

export const RegisterResponseSuccess: Sync = ({ request, user }) => ({
  when: actions(
    [Requesting.request, { path: "/UserAuthentication/register" }, { request }],
    [UserAuthentication.register, {}, { user }],
  ),
  then: actions([Requesting.respond, { request, user }]),
});

export const RegisterResponseError: Sync = ({ request, error }) => ({
  when: actions(
    [Requesting.request, { path: "/UserAuthentication/register" }, { request }],
    [UserAuthentication.register, {}, { error }],
  ),
  then: actions([Requesting.respond, { request, error }]),
});

//-- User Login & Session Creation --//
export const LoginRequest: Sync = ({ request, username, password }) => ({
  when: actions([Requesting.request, {
    path: "/UserAuthentication/login",
    username,
    password,
  }, {
    request,
  }]),
  then: actions([UserAuthentication.login, { username, password }]),
});

export const LoginSuccessCreatesSession: Sync = ({ user }) => ({
  when: actions([UserAuthentication.login, {}, { user }]),
  then: actions([Sessioning.create, { user }]),
});

export const LoginResponseSuccess: Sync = ({ request, user, session }) => ({
  when: actions(
    [Requesting.request, { path: "/UserAuthentication/login" }, { request }],
    [UserAuthentication.login, {}, { user }],
    [Sessioning.create, { user }, { session }],
  ),
  then: actions([Requesting.respond, { request, user, session }]),
});

export const LoginResponseError: Sync = ({ request, error }) => ({
  when: actions(
    [Requesting.request, { path: "/UserAuthentication/login" }, { request }],
    [UserAuthentication.login, {}, { error }],
  ),
  then: actions([Requesting.respond, { request, error }]),
});

//-- User Logout --//
export const LogoutRequest: Sync = ({ request, session, user }) => ({
  when: actions([Requesting.request, {
    path: "/UserAuthentication/logout",
    session,
  }, {
    request,
  }]),
  where: (frames) => frames.query(Sessioning._getUser, { session }, { user }),
  then: actions([Sessioning.delete, { session }]),
});

export const LogoutResponse: Sync = ({ request }) => ({
  when: actions(
    [Requesting.request, { path: "/UserAuthentication/logout" }, { request }],
    [Sessioning.delete, {}, {}],
  ),
  then: actions([Requesting.respond, { request, status: "logged_out" }]),
});

```
